# üç© Gu√≠a: The Simpsons API en Next.js (Proyecto Open Source)

## üéØ Objetivo
Conectar **The Simpsons API** (`https://thesimpsonsapi.com/api/`) en tu proyecto Next.js **sin exponer la URL** en el c√≥digo (para proyectos open source).

## üì° Endpoints disponibles:
- `https://thesimpsonsapi.com/api/characters` - Personajes
- `https://thesimpsonsapi.com/api/episodes` - Episodios
- `https://thesimpsonsapi.com/api/locations` - Ubicaciones

---

## üîê Paso 1: Configurar Variables de Entorno

### **Archivo: `.env.local`** (en la ra√≠z del proyecto)

```bash
# API Base URL - NO usar NEXT_PUBLIC porque queremos ocultarla
SIMPSONS_API_URL=https://thesimpsonsapi.com/api

# Si la API requiere key (actualmente no, pero por si acaso)
# SIMPSONS_API_KEY=tu-api-key
```

### **Archivo: `.env.example`** (para GitHub)

```bash
# The Simpsons API Configuration
SIMPSONS_API_URL=https://thesimpsonsapi.com/api
# SIMPSONS_API_KEY=your-api-key-here
```

### **Archivo: `.gitignore`** (aseg√∫rate que incluye)

```bash
# Variables de entorno
.env*.local
.env
```

---

## üõ°Ô∏è Paso 2: Crear Route Handlers (API Routes)

Estos endpoints **ocultan la URL real** y solo exponen rutas internas como `/api/characters`.

### **Estructura del proyecto:**

```
app/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ characters/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ route.ts
‚îÇ   ‚îú‚îÄ‚îÄ episodes/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ route.ts
‚îÇ   ‚îî‚îÄ‚îÄ locations/
‚îÇ       ‚îî‚îÄ‚îÄ route.ts
‚îî‚îÄ‚îÄ ...
```

---

### **1. Route Handler: Characters**

**Archivo: `app/api/characters/route.ts`**

```typescript
import { NextResponse } from 'next/server'

// GET /api/characters
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const page = searchParams.get('page') || '1'
  
  const apiUrl = process.env.SIMPSONS_API_URL
  
  if (!apiUrl) {
    return NextResponse.json(
      { error: 'API URL not configured' },
      { status: 500 }
    )
  }
  
  try {
    const res = await fetch(`${apiUrl}/characters?page=${page}`, {
      next: { revalidate: 3600 }, // Cachea 1 hora
    })
    
    if (!res.ok) {
      throw new Error(`API responded with status ${res.status}`)
    }
    
    const data = await res.json()
    
    return NextResponse.json(data)
  } catch (error) {
    console.error('Error fetching characters:', error)
    return NextResponse.json(
      { error: 'Failed to fetch characters' },
      { status: 500 }
    )
  }
}
```

---

### **2. Route Handler: Episodes**

**Archivo: `app/api/episodes/route.ts`**

```typescript
import { NextResponse } from 'next/server'

// GET /api/episodes
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const page = searchParams.get('page') || '1'
  
  const apiUrl = process.env.SIMPSONS_API_URL
  
  if (!apiUrl) {
    return NextResponse.json(
      { error: 'API URL not configured' },
      { status: 500 }
    )
  }
  
  try {
    const res = await fetch(`${apiUrl}/episodes?page=${page}`, {
      next: { revalidate: 3600 },
    })
    
    if (!res.ok) {
      throw new Error(`API responded with status ${res.status}`)
    }
    
    const data = await res.json()
    
    return NextResponse.json(data)
  } catch (error) {
    console.error('Error fetching episodes:', error)
    return NextResponse.json(
      { error: 'Failed to fetch episodes' },
      { status: 500 }
    )
  }
}
```

---

### **3. Route Handler: Locations**

**Archivo: `app/api/locations/route.ts`**

```typescript
import { NextResponse } from 'next/server'

// GET /api/locations
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const page = searchParams.get('page') || '1'
  
  const apiUrl = process.env.SIMPSONS_API_URL
  
  if (!apiUrl) {
    return NextResponse.json(
      { error: 'API URL not configured' },
      { status: 500 }
    )
  }
  
  try {
    const res = await fetch(`${apiUrl}/locations?page=${page}`, {
      next: { revalidate: 3600 },
    })
    
    if (!res.ok) {
      throw new Error(`API responded with status ${res.status}`)
    }
    
    const data = await res.json()
    
    return NextResponse.json(data)
  } catch (error) {
    console.error('Error fetching locations:', error)
    return NextResponse.json(
      { error: 'Failed to fetch locations' },
      { status: 500 }
    )
  }
}
```

---

## üì¶ Paso 3: Consumir las APIs desde componentes

### **Opci√≥n A: Server Component (Recomendado para SEO)**

**Archivo: `app/characters/page.tsx`**

```typescript
interface Character {
  _id: number
  name: string
  normalized_name: string
  image_url: string
}

interface ApiResponse {
  docs: Character[]
  total: number
  page: number
  totalPages: number
}

async function getCharacters(page: number = 1): Promise<ApiResponse> {
  // Fetch a TU API interna, no a la API externa
  const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000'
  const res = await fetch(`${baseUrl}/api/characters?page=${page}`, {
    next: { revalidate: 3600 }, // Cachea 1 hora
  })
  
  if (!res.ok) {
    throw new Error('Failed to fetch characters')
  }
  
  return res.json()
}

export default async function CharactersPage() {
  const data = await getCharacters()
  
  return (
    <main className="p-8">
      <h1 className="text-4xl font-bold mb-8">
        Los Simpsons - Personajes
      </h1>
      
      <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {data.docs.map((character) => (
          <div 
            key={character._id} 
            className="border rounded-lg p-4 hover:shadow-lg transition"
          >
            <img
              src={character.image_url}
              alt={character.name}
              className="w-full h-48 object-cover rounded mb-3"
            />
            <h2 className="text-xl font-bold">{character.name}</h2>
          </div>
        ))}
      </div>
      
      <div className="mt-8 text-center">
        <p>P√°gina {data.page} de {data.totalPages}</p>
        <p>Total de personajes: {data.total}</p>
      </div>
    </main>
  )
}
```

---

### **Opci√≥n B: Client Component (para interactividad)**

**Archivo: `app/components/characters-list.tsx`**

```typescript
'use client'

import { useState, useEffect } from 'react'

interface Character {
  _id: number
  name: string
  normalized_name: string
  image_url: string
}

export default function CharactersList() {
  const [characters, setCharacters] = useState<Character[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [page, setPage] = useState(1)
  
  useEffect(() => {
    async function fetchCharacters() {
      setLoading(true)
      try {
        // Llama a TU API interna
        const res = await fetch(`/api/characters?page=${page}`)
        
        if (!res.ok) {
          throw new Error('Error al cargar personajes')
        }
        
        const data = await res.json()
        setCharacters(data.docs)
      } catch (err) {
        setError(err instanceof Error ? err.message : 'Error desconocido')
      } finally {
        setLoading(false)
      }
    }
    
    fetchCharacters()
  }, [page])
  
  if (loading) return <div className="text-center p-8">Cargando...</div>
  if (error) return <div className="text-red-500 p-8">Error: {error}</div>
  
  return (
    <div className="p-8">
      <h1 className="text-4xl font-bold mb-8">Personajes</h1>
      
      <div className="grid grid-cols-4 gap-6">
        {characters.map((character) => (
          <div key={character._id} className="border rounded-lg p-4">
            <img
              src={character.image_url}
              alt={character.name}
              className="w-full h-48 object-cover rounded"
            />
            <h2 className="text-lg font-bold mt-2">{character.name}</h2>
          </div>
        ))}
      </div>
      
      <div className="mt-8 flex justify-center gap-4">
        <button
          onClick={() => setPage(p => Math.max(1, p - 1))}
          disabled={page === 1}
          className="bg-blue-500 text-white px-4 py-2 rounded disabled:opacity-50"
        >
          Anterior
        </button>
        <span className="py-2">P√°gina {page}</span>
        <button
          onClick={() => setPage(p => p + 1)}
          className="bg-blue-500 text-white px-4 py-2 rounded"
        >
          Siguiente
        </button>
      </div>
    </div>
  )
}
```

---

## üé® Ejemplo completo: P√°gina con pesta√±as

**Archivo: `app/page.tsx`**

```typescript
import CharactersTab from './components/characters-tab'
import EpisodesTab from './components/episodes-tab'
import LocationsTab from './components/locations-tab'

export default function Home() {
  return (
    <main className="min-h-screen p-8">
      <header className="mb-8">
        <h1 className="text-5xl font-bold text-yellow-400">
          üç© The Simpsons API
        </h1>
        <p className="text-gray-600 mt-2">
          Explora personajes, episodios y ubicaciones
        </p>
      </header>
      
      {/* Aqu√≠ puedes agregar tabs o secciones */}
      <CharactersTab />
    </main>
  )
}
```

---

## üîÑ Ejemplo con SWR (Recomendado para Client Components)

**Instalaci√≥n:**
```bash
pnpm add swr
```

**Archivo: `app/components/characters-with-swr.tsx`**

```typescript
'use client'

import useSWR from 'swr'

const fetcher = (url: string) => fetch(url).then((res) => res.json())

export default function CharactersWithSWR() {
  const { data, error, isLoading } = useSWR('/api/characters', fetcher, {
    revalidateOnFocus: false,
    dedupingInterval: 60000, // No re-fetch por 1 minuto
  })
  
  if (isLoading) return <div>Cargando...</div>
  if (error) return <div>Error al cargar datos</div>
  
  return (
    <div className="grid grid-cols-4 gap-4">
      {data.docs.map((character: any) => (
        <div key={character._id} className="border p-4 rounded">
          <img src={character.image_url} alt={character.name} />
          <h3>{character.name}</h3>
        </div>
      ))}
    </div>
  )
}
```

---

## üöÄ Desplegar en Vercel (Open Source)

### **1. Agregar variables de entorno en Vercel:**

1. Ve a tu proyecto en Vercel
2. Settings ‚Üí Environment Variables
3. Agrega:
   ```
   SIMPSONS_API_URL = https://thesimpsonsapi.com/api
   ```
4. Marca: Production, Preview, Development

### **2. En tu README.md (para colaboradores):**

```markdown
## üîß Setup

1. Clona el repositorio:
   ```bash
   git clone https://github.com/tu-usuario/simpsons-app.git
   cd simpsons-app
   ```

2. Instala dependencias:
   ```bash
   pnpm install
   ```

3. Configura variables de entorno:
   ```bash
   cp .env.example .env.local
   ```
   
   Edita `.env.local` y agrega:
   ```bash
   SIMPSONS_API_URL=https://thesimpsonsapi.com/api
   ```

4. Corre el proyecto:
   ```bash
   pnpm run dev
   ```

5. Abre [http://localhost:3000](http://localhost:3000)
```

---

## üìÅ Estructura final del proyecto

```
simpsons-app/
‚îú‚îÄ‚îÄ .env.local                    # ‚ùå NO subir a Git
‚îú‚îÄ‚îÄ .env.example                  # ‚úÖ Subir a Git (plantilla)
‚îú‚îÄ‚îÄ .gitignore                    # ‚úÖ Incluye .env*.local
‚îú‚îÄ‚îÄ README.md                     # ‚úÖ Instrucciones de setup
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ characters/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ route.ts         # üõ°Ô∏è Proxy de la API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ episodes/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ route.ts         # üõ°Ô∏è Proxy de la API
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ locations/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ route.ts         # üõ°Ô∏è Proxy de la API
‚îÇ   ‚îú‚îÄ‚îÄ characters/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx             # üìÑ P√°gina de personajes
‚îÇ   ‚îú‚îÄ‚îÄ episodes/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx             # üìÑ P√°gina de episodios
‚îÇ   ‚îú‚îÄ‚îÄ locations/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx             # üìÑ P√°gina de ubicaciones
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ characters-list.tsx  # üé® Componente
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ episodes-list.tsx    # üé® Componente
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ locations-list.tsx   # üé® Componente
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îî‚îÄ‚îÄ page.tsx                 # üè† Home
‚îî‚îÄ‚îÄ package.json
```

---

## üõ°Ô∏è Por qu√© este enfoque es seguro para Open Source

### ‚úÖ Ventajas:

1. **La URL de la API NUNCA aparece en el c√≥digo del cliente**
   - Solo existe en `.env.local` (ignorado por Git)
   - Solo existe en Route Handlers (servidor)

2. **Cualquiera puede clonar el repo**
   - Usan `.env.example` como plantilla
   - Configuran su propia API URL

3. **F√°cil de cambiar la API**
   - Si cambia la URL, solo editas `.env.local`
   - No necesitas cambiar c√≥digo

4. **Control de cach√© y rate limiting**
   - Puedes agregar l√≥gica en Route Handlers
   - Proteges la API externa de abuso

---

## üîí Ejemplo con Rate Limiting (Opcional)

Si quieres proteger a√∫n m√°s tu API:

**Archivo: `app/api/characters/route.ts`** (con rate limiting)

```typescript
import { NextResponse } from 'next/server'

// Simple rate limiting (en producci√≥n usa Redis)
const requestCounts = new Map<string, number>()

export async function GET(request: Request) {
  const ip = request.headers.get('x-forwarded-for') || 'unknown'
  const count = requestCounts.get(ip) || 0
  
  // M√°ximo 10 requests por minuto
  if (count > 10) {
    return NextResponse.json(
      { error: 'Too many requests' },
      { status: 429 }
    )
  }
  
  requestCounts.set(ip, count + 1)
  setTimeout(() => requestCounts.delete(ip), 60000) // Reset despu√©s de 1 min
  
  const apiUrl = process.env.SIMPSONS_API_URL
  
  try {
    const res = await fetch(`${apiUrl}/characters`)
    const data = await res.json()
    return NextResponse.json(data)
  } catch (error) {
    return NextResponse.json(
      { error: 'Failed to fetch' },
      { status: 500 }
    )
  }
}
```

---

## üìä Tipos TypeScript (Opcional pero recomendado)

**Archivo: `types/simpsons.ts`**

```typescript
export interface Character {
  _id: number
  name: string
  normalized_name: string
  image_url: string
}

export interface Episode {
  _id: number
  name: string
  air_date: string
  episode_number: string
}

export interface Location {
  _id: number
  name: string
  normalized_name: string
  image_url: string
}

export interface ApiResponse<T> {
  docs: T[]
  total: number
  page: number
  totalPages: number
}
```

**Uso:**

```typescript
import { Character, ApiResponse } from '@/types/simpsons'

async function getCharacters(): Promise<ApiResponse<Character>> {
  const res = await fetch('/api/characters')
  return res.json()
}
```

---

## üéØ Checklist de seguridad para Open Source

- [ ] `.env.local` est√° en `.gitignore`
- [ ] Creaste `.env.example` con valores placeholder
- [ ] La API URL NO aparece en ning√∫n archivo de c√≥digo
- [ ] Todos los fetches van a `/api/*` (tus Route Handlers)
- [ ] README.md explica c√≥mo configurar variables de entorno
- [ ] Variables agregadas en Vercel para deployment
- [ ] NO usas `NEXT_PUBLIC_` para URLs que quieres ocultar

---

## üí° Ventaja adicional: F√°cil migraci√≥n de API

Si en el futuro cambias de API (ej: de Simpsons a Rick and Morty):

1. Cambias solo el `.env.local`:
   ```bash
   SIMPSONS_API_URL=https://rickandmortyapi.com/api
   ```

2. Ajustas los Route Handlers si la estructura de respuesta cambia

3. **El resto del c√≥digo sigue igual** ‚ú®

---

## üÜò Troubleshooting

### **Error: "API URL not configured"**

```bash
# Verifica que .env.local existe
ls .env.local

# Verifica el contenido
cat .env.local

# Debe contener:
SIMPSONS_API_URL=https://thesimpsonsapi.com/api
```

### **Error: "Failed to fetch"**

```bash
# Verifica que la API est√© funcionando
curl https://thesimpsonsapi.com/api/characters

# Verifica tus Route Handlers
# Abre: http://localhost:3000/api/characters
```

---

## üöÄ Pr√≥ximos pasos

1. Implementa paginaci√≥n
2. Agrega b√∫squeda de personajes
3. Crea p√°ginas de detalle individual
4. Agrega filtros (por temporada, ubicaci√≥n, etc.)
5. Implementa favoritos (localStorage)

---

**¬°Listo para empezar!** üç©‚ú®

Este enfoque es 100% seguro para proyectos open source en GitHub.